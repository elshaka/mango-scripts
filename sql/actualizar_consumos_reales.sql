UPDATE batch_hoppers_lots bhl INNER JOIN batches ON batches.id = bhl.batch_id LEFT OUTER JOIN (SELECT batches.order_id AS order_id, orders.real_production / SUM(amount) AS ratio FROM batch_hoppers_lots INNER JOIN batches ON batches.id = batch_hoppers_lots.batch_id INNER JOIN orders ON batches.order_id = orders.id WHERE orders.real_production IS NOT NULL GROUP BY batches.order_id) AS ratios ON ratios.order_id = batches.order_id SET bhl.real_amount = COALESCE(round(bhl.amount * ratios.ratio, 2), bhl.amount);
